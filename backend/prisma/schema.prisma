// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  SUPERVISOR
  TEACHER
  STUDENT
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  GRADED
  LATE
}

enum AnnouncementPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum FileType {
  DOCUMENT
  IMAGE
  VIDEO
  AUDIO
  OTHER
}

enum EvaluationStatus {
  ACCEPTED
  REJECTED
}

enum ReviewStatus {
  PENDING_TEACHER_REVIEW
  PENDING_ADMIN_REVIEW
  APPROVED_BY_ADMIN
}

enum HourRequestStatus {
  PENDING
  APPROVED
  REJECTED
  MODIFIED
}

enum InstallmentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      Role
  firstName String
  lastName  String
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations based on role
  student      Student?
  teacher      Teacher?
  announcements Announcement[]
  filesUploaded File[]

  refreshTokens RefreshToken[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Student {
  id             String    @id @default(uuid())
  userId         String    @unique
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentEmail    String?
  parentPhone    String?
  enrollmentDate DateTime  @default(now())
  classId        String?
  class          Class?    @relation(fields: [classId], references: [id], onDelete: SetNull)
  
  submissions   Submission[]
  grades        Grade[]
  evaluations   Evaluation[]
  teachers      StudentTeacher[]
  subjects      StudentSubject[]
  classes       StudentClass[]
  pointTransactions PointTransaction[]
  discounts     StudentDiscount[]
  installments  StudentInstallment[]
  payments      PaymentRecord[]

  @@index([userId])
  @@index([classId])
  @@map("students")
}

model Teacher {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject        String?
  specialization String?
  hireDate       DateTime @default(now())

  classes     Class[]
  homework    Homework[]
  grades      Grade[]
  evaluations Evaluation[]
  students    StudentTeacher[]
  subjects    TeacherSubject[]
  studentSubjects StudentSubject[]
  submissions Submission[]
  salaries    TeacherSalary[]
  hourRequests HourRequest[]
  payrollRecords MonthlyPayrollRecord[]

  @@index([userId])
  @@map("teachers")
}

model Class {
  id           String   @id @default(uuid())
  name         String
  grade        String?
  academicYear String?
  teacherId    String?
  teacher      Teacher? @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  students       Student[]
  homework       Homework[]
  subjects       Subject[]
  studentClasses StudentClass[]
  classSubjects  ClassSubject[]

  @@index([teacherId])
  @@index([academicYear])
  @@map("classes")
}

model Subject {
  id                String   @id @default(uuid())
  name              String
  code              String?
  description       String?
  monthlyInstallment Decimal? @db.Decimal(10, 2)
  classId           String?
  class             Class?   @relation(fields: [classId], references: [id], onDelete: SetNull)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  grades    Grade[]
  homework  Homework[]
  teachers  TeacherSubject[]
  students  StudentSubject[]
  submissions Submission[]
  pointTransactions PointTransaction[]
  classSubjects ClassSubject[]

  @@index([classId])
  @@index([code])
  @@map("subjects")
}

model Homework {
  id          String   @id @default(uuid())
  title       String
  description String
  dueDate     DateTime?
  classId     String?
  class       Class?   @relation(fields: [classId], references: [id], onDelete: SetNull)
  subjectId   String?
  subject     Subject? @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  teacherId   String?
  teacher     Teacher? @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  fileUrls    String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  submissions Submission[]
  files       File[]

  @@index([classId])
  @@index([subjectId])
  @@index([teacherId])
  @@index([dueDate])
  @@map("homework")
}

model Submission {
  id          String           @id @default(uuid())
  title       String?
  description String?
  homeworkId  String?
  homework    Homework?        @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  subjectId   String?
  subject     Subject?         @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  studentId   String
  student     Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacherId   String?
  teacher     Teacher?         @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  submittedAt DateTime?
  fileUrls    String[]
  status      SubmissionStatus @default(PENDING)
  
  // New admin review workflow fields
  reviewStatus        ReviewStatus       @default(PENDING_TEACHER_REVIEW)
  teacherEvaluation   EvaluationStatus?
  teacherFeedback     String?
  teacherReviewedAt   DateTime?
  adminEvaluation     EvaluationStatus?
  adminFeedback       String?
  adminReviewedBy     String?
  adminReviewedAt     DateTime?
  
  // Legacy fields (kept for backward compatibility)
  grade       Float?
  feedback    String?
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  files File[]

  @@index([homeworkId])
  @@index([subjectId])
  @@index([studentId])
  @@index([teacherId])
  @@index([status])
  @@index([reviewStatus])
  @@map("submissions")
}

model Grade {
  id           String   @id @default(uuid())
  studentId    String
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subjectId    String
  subject      Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  grade        Float
  term         String
  academicYear String
  teacherId    String
  teacher      Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([studentId])
  @@index([subjectId])
  @@index([teacherId])
  @@index([academicYear, term])
  @@map("grades")
}

model Announcement {
  id          String                @id @default(uuid())
  title       String
  content     String
  authorId    String
  author      User                  @relation(fields: [authorId], references: [id], onDelete: Cascade)
  targetRoles Role[]
  priority    AnnouncementPriority  @default(NORMAL)
  expiresAt   DateTime?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  files File[]

  @@index([authorId])
  @@index([createdAt])
  @@index([priority])
  @@map("announcements")
}

model File {
  id             String   @id @default(uuid())
  name           String
  url            String
  type           FileType
  size           Int
  uploadedById   String
  uploadedBy     User     @relation(fields: [uploadedById], references: [id], onDelete: Cascade)
  
  // Polymorphic relations (optional fields)
  homeworkId     String?
  homework       Homework? @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  submissionId   String?
  submission     Submission? @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  announcementId String?
  announcement   Announcement? @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([uploadedById])
  @@index([homeworkId])
  @@index([submissionId])
  @@index([announcementId])
  @@map("files")
}

model Evaluation {
  id               String   @id @default(uuid())
  studentId        String
  student          Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacherId        String
  teacher          Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  term             String
  academicYear     String
  behaviorScore    Float
  performanceScore Float
  comments         String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([studentId])
  @@index([teacherId])
  @@index([academicYear, term])
  @@map("evaluations")
}

model StudentTeacher {
  id          String   @id @default(uuid())
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  teacherId   String
  teacher     Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  assignedBy  String   // User ID of admin/supervisor who made the assignment
  assignedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([studentId, teacherId])
  @@index([studentId])
  @@index([teacherId])
  @@index([assignedBy])
  @@map("student_teachers")
}

model TeacherSubject {
  id          String   @id @default(uuid())
  teacherId   String
  teacher     Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  subjectId   String
  subject     Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  assignedBy  String   // User ID of admin/supervisor who made the assignment
  assignedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([teacherId])
  @@index([subjectId])
  @@index([assignedBy])
  @@index([teacherId, subjectId])
  @@map("teacher_subjects")
}

model StudentSubject {
  id          String   @id @default(uuid())
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subjectId   String
  subject     Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacherId   String?  // Optional: Teacher assigned to teach this subject to this student
  teacher     Teacher? @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  enrolledBy  String   // User ID of admin/supervisor who made the enrollment
  enrolledAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([studentId, subjectId])
  @@index([studentId])
  @@index([subjectId])
  @@index([teacherId])
  @@index([enrolledBy])
  @@map("student_subjects")
}

model StudentClass {
  id          String   @id @default(uuid())
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  classId     String
  class       Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  assignedBy  String   // User ID of admin/supervisor who made the assignment
  assignedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([studentId, classId])
  @@index([studentId])
  @@index([classId])
  @@index([assignedBy])
  @@map("student_classes")
}

model ClassSubject {
  id          String   @id @default(uuid())
  classId     String
  class       Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  subjectId   String
  subject     Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  assignedBy  String   // User ID of admin/supervisor who made the assignment
  assignedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([classId, subjectId])
  @@index([classId])
  @@index([subjectId])
  @@index([assignedBy])
  @@map("class_subjects")
}

model PointTransaction {
  id         String   @id @default(uuid())
  studentId  String
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subjectId  String?
  subject    Subject? @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  amount     Int      // positive to add, negative to deduct
  createdAt  DateTime @default(now())

  @@index([studentId])
  @@index([studentId, createdAt])
  @@index([studentId, subjectId])
  @@map("point_transactions")
}

model TeacherSalary {
  id           String   @id @default(uuid())
  teacherId    String
  teacher      Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  monthlySalary Decimal?
  hourlyWage   Decimal?
  effectiveFrom DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([teacherId])
  @@index([effectiveFrom])
  @@map("teacher_salaries")
}

model HourRequest {
  id                 String            @id @default(uuid())
  teacherId          String
  teacher            Teacher           @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  date               DateTime
  hours              Decimal
  minutes            Int               @default(0)
  status             HourRequestStatus @default(PENDING)
  adminModifiedHours Decimal?
  adminModifiedMinutes Int?
  adminFeedback      String?
  reviewedBy         String?
  reviewedAt         DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime         @updatedAt

  @@index([teacherId])
  @@index([date])
  @@index([status])
  @@index([teacherId, date])
  @@map("hour_requests")
}

model MonthlyPayrollRecord {
  id              String   @id @default(uuid())
  teacherId       String
  teacher         Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  month           Int
  year            Int
  monthlySalary   Decimal  @default(0)
  totalHours      Decimal  @default(0)
  hourlyWage      Decimal  @default(0)
  totalEntitlement Decimal
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([teacherId, month, year])
  @@index([teacherId])
  @@index([year, month])
  @@map("monthly_payroll_records")
}

model StudentDiscount {
  id          String    @id @default(uuid())
  studentId   String
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  amount      Decimal   @db.Decimal(10, 2)
  reason      String?
  isActive    Boolean   @default(true)
  createdBy   String    // User ID of admin who created the discount
  cancelledAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([studentId])
  @@index([isActive])
  @@index([createdBy])
  @@map("student_discounts")
}

model StudentInstallment {
  id               String           @id @default(uuid())
  studentId         String
  student           Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  month             Int
  year              Int
  totalAmount       Decimal          @db.Decimal(10, 2)
  paidAmount        Decimal          @default(0) @db.Decimal(10, 2)
  outstandingAmount Decimal          @default(0) @db.Decimal(10, 2)
  discountAmount    Decimal          @default(0) @db.Decimal(10, 2)
  status            InstallmentStatus @default(PENDING)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  payments PaymentRecord[]

  @@unique([studentId, month, year])
  @@index([studentId])
  @@index([year, month])
  @@index([status])
  @@index([studentId, year, month])
  @@map("student_installments")
}

model PaymentRecord {
  id            String            @id @default(uuid())
  studentId     String
  student       Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  installmentId String
  installment   StudentInstallment @relation(fields: [installmentId], references: [id], onDelete: Cascade)
  amount        Decimal           @db.Decimal(10, 2)
  paymentDate   DateTime
  paymentMethod String?
  notes         String?
  recordedBy    String            // User ID of admin who recorded the payment
  createdAt     DateTime          @default(now())

  @@index([studentId])
  @@index([installmentId])
  @@index([paymentDate])
  @@index([recordedBy])
  @@map("payment_records")
}
